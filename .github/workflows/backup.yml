name: Scheduled Backup

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Backup retention days'
        required: false
        default: '7'

env:
  DEPLOY_PATH: /opt/netsurf-automation

jobs:
  backup:
    name: Run Backup
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Execute backup script
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && ./scripts/backup.sh"

      - name: Verify backup created
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "ls -la ${{ env.DEPLOY_PATH }}/backups/ | tail -5"

      - name: Clean old backups
        run: |
          RETENTION=${{ github.event.inputs.retention_days || '7' }}
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} \
            "find ${{ env.DEPLOY_PATH }}/backups/ -type f -mtime +$RETENTION -delete"

      - name: Notify on failure
        if: failure()
        run: |
          echo "Backup failed! Immediate attention required."
          # Add notification logic (email, Slack, etc.)

  verify:
    name: Verify Backup Integrity
    runs-on: ubuntu-latest
    needs: [backup]

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check backup file integrity
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            LATEST_BACKUP=$(ls -t ${{ env.DEPLOY_PATH }}/backups/*.sql.gz 2>/dev/null | head -1)
            if [ -z "$LATEST_BACKUP" ]; then
              echo "No backup found!"
              exit 1
            fi

            # Check file is not empty
            SIZE=$(stat -f%z "$LATEST_BACKUP" 2>/dev/null || stat -c%s "$LATEST_BACKUP")
            if [ "$SIZE" -lt 1000 ]; then
              echo "Backup file suspiciously small: $SIZE bytes"
              exit 1
            fi

            echo "Latest backup: $LATEST_BACKUP ($SIZE bytes)"
            echo "Backup verification passed"
          EOF
